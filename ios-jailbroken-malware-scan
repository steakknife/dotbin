#!/usr/bin/env bash
# set IOS_DEVICE to your iOS devices' openssh username@hostname
# prints 'sploits found on stderr
# prints absence of 'sploits on stdout
# exit code 1 if any sploits are found
set -e

IOS_DEVICE="${IOS_DEVICE-root@172.20.10.1}"
SPLOITS="$(grep '^..*().*{' "$0" | sed '/=/d;s/(.*//g')"

# --- every function is assumed to be a 'sploit detector

AppBuyer() {
  cat << PWND
/System/Library/LaunchDaemons/com.archive.plist
/bin/updatesrv
/tmp/updatesrv.log
/etc/uuid
/Library/MobileSubstrate/DynamicLibraries/aid.dylib
/usr/bin/gzip
PWND
}

AdThief() {
  cat << PWND
/Library/MobileSubstrate/DynamicLibraries/spad.dylib
/Library/MobileSubstrate/DynamicLibraries/spad.plist
/Library/MobileSubstrate/DynamicLibraries/libgad.dylib
PWND
}

Unflod() { # aka SSLCreds
  cat << PWND
/Library/MobileSubstrate/DynamicLibraries/Unflod.dylib
PWND
}

WireLurker() {
  cat << PWND
/Library/MobileSubstrate/DynamicLibraries/sfbase.dylib
PWND
}

# ---- main

cat << HEADER

$0 - very basic anti-malware checking; sucky as all anti-virus"


HEADER

echo "Connecting to iOS device $IOS_DEVICE"
ssh -o ConnectTimeout=8 "$IOS_DEVICE" 'true' # connection test
echo "Connected to iOS device $IOS_DEVICE"

for SPLOIT in $SPLOITS; do
  $SPLOIT | ssh "$IOS_DEVICE" 'xargs -I% find "%" -type f -ls 2>/dev/null' \
     | sed "s/^/$SPLOIT /g" \
     | grep --color=none '/' \
  || echo "$SPLOIT not found"
done | tee /dev/stderr | if grep --mmap --color=none '.' >/dev/null; then false; else true; fi
